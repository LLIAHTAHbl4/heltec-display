name: Build Heltec V3.1 Project
on: [push, workflow_dispatch, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
      
    - name: Install ESP32 core (S3)
      run: |
        arduino-cli config init
        arduino-cli config add board_manager.additional_urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
        arduino-cli core update-index
        arduino-cli core install esp32:esp32@2.0.14
        
    - name: Install required libraries
      run: |
        arduino-cli lib install "ESP8266 and ESP32 OLED driver for SSD1306 displays"
        arduino-cli lib install "Adafruit AHTX0"
        arduino-cli lib install "Adafruit SHT31 Library"
        
    - name: Prepare sketch directory
      run: |
        # Создаем директорию для скетча (требование Arduino CLI)
        mkdir -p heltec_project
        
        # Ищем .ino файл
        if [ -f "heltec_sensors.ino" ]; then
          echo "✅ Копирую heltec_sensors.ino в директорию проекта"
          cp heltec_sensors.ino heltec_project/
          SKETCH_DIR="heltec_project"
        elif [ -f "main.ino" ]; then
          echo "✅ Копирую main.ino в директорию проекта"
          cp main.ino heltec_project/
          SKETCH_DIR="heltec_project"
        else
          # Если нет .ino файла, создаем минимальный
          echo "⚠️  .ino файл не найден, создаю минимальный скетч"
          cat > heltec_project/heltec_sensors.ino << 'EOF'
#include "SH1106Wire.h"
#include <Wire.h>

#define OLED_VEXT 10
#define OLED_RST 21
SH1106Wire display(0x3C, 17, 18);

void setup() {
  pinMode(OLED_VEXT, OUTPUT);
  digitalWrite(OLED_VEXT, LOW);
  pinMode(OLED_RST, OUTPUT);
  digitalWrite(OLED_RST, LOW);
  delay(50);
  digitalWrite(OLED_RST, HIGH);
  display.init();
  display.flipScreenVertically();
  display.drawString(0,0,"HELLO");
  display.display();
}
void loop() {}
EOF
          SKETCH_DIR="heltec_project"
        fi
        
        echo "Директория скетча: $SKETCH_DIR"
        echo "Содержимое:"
        ls -la $SKETCH_DIR/
        
    - name: Compile for ESP32-S3
      run: |
        # Компилируем из директории проекта
        arduino-cli compile \
          --fqbn esp32:esp32:esp32s3 \
          --build-property "build.partitions=default" \
          --build-property "upload.maximum_size=4194304" \
          --build-property "upload.speed=921600" \
          --build-property "compiler.cpp.extra_flags=-Wno-error=deprecated-declarations" \
          --warnings all \
          heltec_project/
          
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: build/esp32.esp32.esp32s3/*.bin
        retention-days: 30
