name: Build Heltec V3.1 Project
on: [push, workflow_dispatch, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
      
    - name: Install ESP32 core (S3)
      run: |
        arduino-cli config init
        arduino-cli config add board_manager.additional_urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
        arduino-cli core update-index
        arduino-cli core install esp32:esp32@2.0.14
        
    - name: Install required libraries
      run: |
        arduino-cli lib install "ESP8266 and ESP32 OLED driver for SSD1306 displays"
        arduino-cli lib install "Adafruit AHTX0"
        arduino-cli lib install "Adafruit SHT31 Library"
        
    - name: Find and compile sketch
      run: |
        # Ищем файл .ino в репозитории
        SKETCH_FILE=$(find . -name "*.ino" -type f | head -1)
        
        if [ -z "$SKETCH_FILE" ]; then
          echo "❌ Ошибка: не найден ни один .ino файл в репозитории"
          echo "Создайте файл с расширением .ino в корне репозитория"
          exit 1
        fi
        
        echo "✅ Найден скетч: $SKETCH_FILE"
        
        # Компилируем
        arduino-cli compile \
          --fqbn esp32:esp32:esp32s3 \
          --build-property "build.partitions=default" \
          --build-property "upload.maximum_size=4194304" \
          --build-property "upload.speed=921600" \
          --build-property "compiler.cpp.extra_flags=-Wno-error=deprecated-declarations" \
          --warnings all \
          "$SKETCH_FILE"
          
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: build/esp32.esp32.esp32s3/*.bin
        retention-days: 30
